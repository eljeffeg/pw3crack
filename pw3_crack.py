#!/usr/bin/env python3
# PW3 Cracker

import sys
import os
from binascii import hexlify, unhexlify
import re


pwbase = 838  # Location in file of password
key = {
    "0": ['E8', 'E8', '38', '32', 'FD', '00', '06', '32', 'F8', '33', '01', '36', '06', 'F8', '34', 'FD'],
    "1": ['EA', 'EA', 'EC', '04', 'FE', '01', '31', '04', 'F9', '00', '02', 'F4', '31', 'F9', 'FC', 'FE'],
    "2": ['38', '38', 'ED', '05', '33', '02', '08', '05', 'FA', '01', '32', 'F5', '08', 'FA', 'FD', '33'],
    "3": ['EC', 'EC', 'EE', '06', '00', '32', '09', '06', '34', '02', '04', 'F6', '09', '34', 'FE', '00'],
    "4": ['ED', 'ED', '37', '31', '01', '04', '0A', '31', 'FC', '32', '05', '35', '0A', 'FC', '33', '01'],
    "5": ['EE', 'EE', 'F0', '08', '02', '05', '30', '08', 'FD', '04', '06', 'F8', '30', 'FD', '00', '02'],
    "6": ['37', '37', 'F1', '09', '32', '06', '0C', '09', 'FE', '05', '31', 'F9', '0C', 'FE', '01', '32'],
    "7": ['F0', 'F0', 'F2', '0A', '04', '31', '0D', '0A', '33', '06', '08', 'FA', '0D', '33', '02', '04'],
    "8": ['F1', 'F1', '36', '30', '05', '08', '0E', '30', '00', '31', '09', '34', '0E', '00', '32', '05'],
    "9": ['F2', 'F2', 'F4', '0C', '06', '09', '2F', '0C', '01', '08', '0A', 'FC', '2F', '01', '04', '06'],
    ":": ['36', '36', 'F5', '0D', '31', '0A', '10', '0D', '02', '09', '30', 'FD', '10', '02', '05', '31'],
    ";": ['F4', 'F4', 'F6', '0E', '08', '30', '11', '0E', '32', '0A', '0C', 'FE', '11', '32', '06', '08'],
    "<": ['F5', 'F5', '35', '2F', '09', '0C', '12', '2F', '04', '30', '0D', '33', '12', '04', '31', '09'],
    "=": ['F6', 'F6', 'F8', '10', '0A', '0D', '2E', '10', '05', '0C', '0E', '00', '2E', '05', '08', '0A'],
    ">": ['35', '35', 'F9', '11', '30', '0E', '14', '11', '06', '0D', '2F', '01', '14', '06', '09', '30'],
    "?": ['F8', 'F8', 'FA', '12', '0C', '2F', '15', '12', '31', '0E', '10', '02', '15', '31', '0A', '0C'],
    "@": ['F9', 'F9', '34', '2E', '0D', '10', '16', '2E', '08', '2F', '11', '32', '16', '08', '30', '0D'],
    "A": ['FA', 'FA', 'FC', '14', 'OE', '11', '2D', '14', '09', '10', '12', '04', '2D', '09', '0C', '0E'],
    "B": ['34', '34', 'FD', '15', '2F', '12', '18', '15', '0A', '11', '2E', '05', '18', '0A', '0D', '2F'],
    "C": ['FC', 'FC', 'FE', '16', '10', '2E', '19', '16', '30', '12', '14', '06', '19', '30', '0E', '10'],
    "D": ['FD', 'FD', '33', '2D', '11', '14', '1A', '2D', '0C', '2E', '15', '31', '1A', '0C', '2F', '11'],
    "E": ['FE', 'FE', '00', '18', '12', '15', '2C', '18', '0D', '14', '16', '08', '2C', '0D', '10', '12'],
    "F": ['33', '33', '01', '19', '2E', '16', '1C', '19', '0E', '15', '2D', '09', '1C', '0E', '11', '2E'],
    "G": ['00', '00', '02', '1A', '14', '2D', '1D', '1A', '2F', '16', '18', '0A', '1D', '2F', '12', '14'],
    "H": ['01', '01', '32', '2C', '15', '18', '1E', '2C', '10', '2D', '19', '30', '13', '10', '2E', '15'],
    "I": ['02', '02', '04', '1C', '16', '19', '2B', '1C', '11', '18', '1A', '0C', '2B', '11', '14', '16'],
    "J": ['32', '32', '05', '1D', '2D', '1A', '20', '1D', '12', '19', '2C', '0D', '20', '12', '15', '2D'],
    "K": ['04', '04', '06', '1E', '18', '2C', '21', '1E', '2E', '1A', '1C', '0E', '21', '2E', '16', '18'],
    "L": ['05', '05', '31', '2B', '19', '1C', '22', '2B', '14', '2C', '1D', '2F', '22', '14', '2D', '19'],
    "M": ['06', '06', '08', '20', '1A', '1D', '2A', '20', '15', '1C', '1E', '10', '2A', '15', '18', '1A'],
    "N": ['31', '31', '09', '21', '2C', '1E', '24', '21', '16', '1D', '2B', '11', '24', '16', '19', '2C'],
    "O": ['08', '08', '0A', '22', '1C', '2B', '25', '22', '2D', '1E', '20', '12', '25', '2D', '1A', '1C'],
    "P": ['09', '09', '30', '2A', '1D', '20', '26', '2A', '18', '2B', '21', '2E', '26', '18', '2C', '1D'],
    "Q": ['0A', '0A', '0C', '24', '1E', '21', '29', '24', '19', '20', '22', '14', '29', '19', '1C', '1E'],
    "R": ['30', '30', '0D', '25', '2B', '22', '28', '25', '1A', '21', '2A', '15', '28', '1A', '1D', '2B'],
    "S": ['0C', '0C', '0E', '26', '20', '2A', 'A8', '26', '2C', '22', '24', '16', 'A8', '2C', '1E', '20'],
    "T": ['0D', '0D', '2F', '29', '21', '24', '49', '29', '1C', '2A', '25', '2D', '49', '1C', '2B', '21'],
    "U": ['0E', '0E', '10', '28', '22', '25', 'A6', '28', '1D', '24', '26', '18', 'A6', '1D', '20', '22'],
    "V": ['2F', '2F', '11', 'A8', '2A', '26', 'A5', 'A8', '1E', '25', '29', '19', 'A5', '1E', '21', '2A'],
    "W": ['10', '10', '12', '49', '24', '29', 'A4', '49', '2B', '26', '28', '1A', 'A4', '2B', '22', '24'],
    "X": ['11', '11', '2E', 'A6', '25', '28', '4A', 'A6', '20', '29', 'A8', '2C', '4A', '20', '2A', '25'],
    "Y": ['12', '12', '14', 'A5', '26', 'A8', 'A2', 'A5', '21', '28', '49', '1C', 'A2', '21', '24', '26'],
    "Z": ['2E', '2E', '15', 'A4', '29', '49', 'A1', 'A4', '22', 'A8', 'A6', '1D', 'A1', '22', '25', '29'],
    "a": ['1A', '1A', '1C', '9D', '4A', 'A0', '9A', '9D', 'A8', 'A1', '4B', '24', '9A', 'A8', 'A5', '4A'],
    "b": ['2C', '2C', '1D', '9C', 'A2', '4B', '99', '9C', '49', 'A0', '9E', '25', '99', '49', 'A4', 'A2'],
    "c": ['1C', '1C', '1E', '4C', 'A1', '9E', '98', '4C', 'A6', '4B', '9D', '26', '98', 'A6', '4A', 'A1'],
    "d": ['1D', '1D', '2B', '9A', 'A0', '9D', '4D', '9A', 'A5', '9E', '9C', '29', '4D', 'A5', 'A2', 'A0'],
    "e": ['1E', '1E', '20', '99', '4B', '9C', '96', '99', 'A4', '9D', '4C', '28', '96', 'A4', 'A1', '4B'],
    "f": ['2B', '2B', '21', '98', '9E', '4C', '95', '98', '4A', '9C', '9A', 'A8', '95', '4A', 'A0', '9E'],
    "g": ['20', '20', '22', '4D', '9D', '9A', '94', '4D', 'A2', '4C', '99', '49', '94', 'A2', '4B', '9D'],
    "h": ['21', '21', '2A', '96', '9C', '99', '4E', '96', 'A1', '9A', '98', 'A6', '4E', 'A1', '9E', '9C'],
    "i": ['22', '22', '24', '95', '4C', '98', '92', '95', 'A0', '99', '4D', 'A5', '92', 'A0', '9D', '4C'],
    "j": ['2A', '2A', '25', '94', '9A', '4D', '91', '94', '4B', '98', '96', 'A4', '91', '4B', '9C', '9A'],
    "k": ['24', '24', '26', '4E', '99', '96', '90', '4E', '9E', '4D', '95', '4A', '90', '9E', '4C', '99'],
    "l": ['25', '25', '29', '92', '98', '95', '4F', '92', '9D', '96', '94', 'A2', '4F', '9D', '9A', '98'],
    "m": ['26', '26', '28', '91', '4D', '94', '8E', '91', '9C', '95', '4E', 'A1', '8E', '9C', '99', '4D'],
    "n": ['29', '29', 'a8', '90', '96', '4E', '8D', '90', '4C', '94', '92', 'A0', '8D', '4C', '98', '96'],
    "o": ['28', '28', '49', '4F', '95', '92', '8C', '4F', '9A', '4E', '91', '4B', '8C', '9A', '4D', '95'],
    "p": ['A8', 'A8', 'A6', '8E', '94', '91', '50', '8E', '99', '92', '90', '9E', '50', '99', '96', '94'],
    "q": ['49', '49', 'A5', '8D', '4E', '90', '8A', '8D', '98', '91', '4F', '9D', '8A', '98', '95', '4E'],
    "r": ['A6', 'A6', 'A4', '8C', '92', '4F', '89', '8C', '4D', '90', '8E', '9C', '89', '4D', '94', '92'],
    "s": ['A5', 'A5', '4A', '50', '91', '8E', '88', '50', '96', '4F', '8D', '4C', '88', '96', '4E', '91'],
    "t": ['A4', 'A4', 'A2', '8A', '90', '8D', '51', '8A', '95', '8E', '8C', '9A', '51', '95', '92', '90'],
    "u": ['4A', '4A', 'A1', '89', '4F', '8C', '86', '89', '94', '8D', '50', '99', '86', '94', '91', '4F'],
    "v": ['A2', 'A2', 'A0', '88', '8E', '50', '85', '88', '4E', '8C', '8A', '98', '85', '4E', '90', '8E'],
    "w": ['A1', 'A1', '4B', '51', '8D', '8A', '84', '51', '92', '50', '89', '4D', '84', '92', '4F', '8D'],
    "x": ['A0', 'A0', '9E', '86', '8C', '89', '52', '86', '91', '8A', '88', '96', '52', '91', '8E', '8C'],
    "y": ['4B', '4B', '9D', '85', '50', '88', '82', '85', '90', '89', '51', '95', '82', '90', '8D', '50'],
    "z": ['9E', '9E', '9C', '84', '8A', '51', '81', '84', '4F', '88', '86', '94', '81', '4F', '8C', '8A'],
    "!": ['DA', 'DA', 'DC', 'F4', 'EE', "F1", '35', 'F4', 'E8', 'F0', 'F2', 'E4', '35', 'E8', 'EC', 'EE'],
    "-": ['E6', 'E6', 'E9', '00', 'FA', 'FD', '32', '00', 'F5', 'FC', 'FE', 'F0', '32', 'F5', 'F8', 'FA'],
    ".": ['39', '39', 'E8', '01', '34', 'FE', '04', '01', 'F6', 'FD', '33', 'F1', '04', 'F6', 'F9', '34'],
    "/": ['E9', 'E9', 'EA', '02', 'FC', '33', '05', '02', '35', 'FE', '00', 'F2', '05', '35', 'FA', 'FC'],
    "~": ['9A', '9A', '98', '80', '86', '52', '7D', '80', '50', '84', '82', '90', '7D', '50', '88', '86'],
    "{": ['9D', '9D', '4C', '52', '89', '86', '80', '52', '8E', '51', '85', '4E', '80', '8E', '50', '89'],
    "|": ['9C', '9C', '9A', '82', '88', '85', '53', '82', '8D', '86', '84', '92', '53', '8D', '8A', '88'],
    "}": ['4C', '4C', '99', '81', '51', '84', '7E', '81', '8C', '85', '52', '91', '7E', '8C', '89', '51'],
    "+": ['E4', 'E4', 'E6', 'FE', 'F8', '34', '01', 'FE', '36', 'FA', 'FC', 'EE', '01', '36', 'F6', 'F8'],
    ",": ['E5', 'E5', '39', '33', 'F9', 'FC', '02', '33', 'F4', '34', 'FD', '37', '02', 'F4', '35', 'F9'],
    "[": ['14', '14', '16', '4A', '28', 'A6', 'A0', '4A', '2A', '49', 'A5', '1E', 'A0', '2A', '26', '28'],
    "]": ['16', '16', '18', 'A1', '49', 'A4', '9E', 'A1', '25', 'A5', '4A', '20', '9E', '25', '28', '49'],
    "^": ['2D', '2D', '19', 'A0', 'A6', '4A', '9D', 'A0', '26', 'A4', 'A2', '21', '9D', '26', 'A8', 'A6'],
    "_": ['18', '18', '1A', '4B', 'A5', 'A2', '9C', '4B', '29', '4A', 'A1', '22', '9C', '29', '49', 'A5'],
    "`": ['19', '19', '2C', '9E', 'A4', 'A1', '4C', '9E', '28', 'A2', 'A0', '2A', '4C', '28', 'A6', 'A4'],
    "\\": ['15', '15', '2D', 'A2', 'A8', 'A5', '4B', 'A2', '24', 'A6', 'A4', '2B', '4B', '24', '29', 'A8'],
    }


def splitString(string, number):
    return re.findall(r"..", string + str(number))

def main():
    if len(sys.argv) < 2:
        print("File path required.  'pw3_crack.py ./doc.txt'")
        exit()

    filepath = sys.argv[1]
    if not os.path.exists(filepath):
        print(f"File {filepath} does not exist.")
        exit()

    f = open(filepath, "rb")
    f.seek(pwbase)
    password_length = f.read(1)[0]
    f.seek(pwbase + 1)
    ciphertext = splitString(hexlify(f.read(password_length)).decode("utf8"), 2)
    plaintext = ["?" for x in range(password_length)]
    
    for i in range(password_length):
        for val in key:
            if i < 16 and i < len(key[val]):
                keyval = key[val][i]
            elif i >= 16 and i - 15 < len(key[val]):
                kv = int(key[val][i - 16], 16) + 16
                if kv > 255:
                    kv = kv - 256
                keyval = f'{kv:x}'
            else:
                continue
            if keyval.lower() == ciphertext[i].lower():
                plaintext[i] = val

    print("Extracted Password: " + "".join(ciphertext))
    print("Decrypted Password: " + "".join(plaintext))
   
if __name__ == "__main__":
    main()
